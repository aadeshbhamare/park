







</head>
<body>
  <script>
    if (sessionStorage.getItem('userRole') !== 'customer') { window.location.href = 'index.html'; }
  </script>
  <header>
    <div class="header-logo-left">
        <!-- This is your new logo image -->
        <img src="logo.PNG" alt="SmartPark Company Logo" style="height:60px;">
        <div class="logo">SmartPark</div>
    </div>
<header style="justify-content: flex-start; gap: 14rem;">
    <nav><ul><li><a href="#dashboard-section" class="header-link">Dashboard </a></li><li>
        <a href="#" id="logout-btn">Logout</a></li></ul>
      <nav><ul><li><a href="privacy.html" class="header-link">Privacy Policy</a></li><li><a href="terms.html" class="header-link">Terms & Conditions</a></nav></nav></ul>
     <!-- National Flag --></header>
    <img src="https://upload.wikimedia.org/wikipedia/en/4/41/Flag_of_India.svg" alt="Indian Flag" class="national-flag" id="instruction-flag"> 
</header>
  <section class="hero" id="hero">
    <h1>The Ultimate Parking Experience</h1>
    <p>Select a zone from the list, choose your exact spots from a live map, and get instant confirmation.</p>
    <button onclick="document.getElementById('dashboard-section').scrollIntoView()">Find a Spot</button>
  </section>
  <div class="container" id="dashboard-section">
    <div class="dashboard-grid">
        <div class="card">
            <h2 class="card-title"><i class="fas fa-wallet"></i> Wallet & Tokens</h2>
            <div id="walletStatus" class="wallet-status">
                <i class="fas fa-exclamation-circle"></i> 
                <span>Wallet not connected</span></div>
            <div class="balance"><i class="fas fa-coins"></i> 
                <span id="tokenBalance">0 SPARK</span></div>
            <button id="connectWallet" class="btn"><i class="fas fa-plug"></i> Connect Wallet</button>
            <!-- Indian flag under Wallet -->
<img src="https://www.pngkey.com/png/detail/32-325237_download-indian-flag-wallpaper-source-flag-of-india.png" alt="Indian Flag" class="wallet-flag">
        </div>
        <div class="card">
            <h2 class="card-title"><i class="fas fa-map-marked-alt"></i> Parking Zones</h2>
            <div id="zonesContainer" class="zones-grid"></div>
        </div>
    </div>
    
    <div id="sessionPanel" class="session-panel"></div>

    <div class="card" id="map-section">
        <div class="map-header">
            <h2 class="card-title"><i class="fas fa-globe-asia"></i> Zone Locations Map</h2>
            <button id="fullscreen-btn" class="btn" title="Enter fullscreen mode"><i class="fas fa-expand"></i></button>
        </div>
        <div class="map-search-bar">
            <input type="text" id="map-search-input" placeholder="Search for a location (e.g., Bibwewadi, Pune)">
            <button id="map-search-btn" class="btn" title="Search"><i class="fas fa-search"></i></button>
        </div>
        <div id="map-container">
            <iframe id="map-iframe" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15137.99972851218!2d73.8536679!3d18.4719754!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3bc2eac92b8217bd%3A0x1d37ff2249eda817!2sBibwewadi%2C%20Pune%2C%20Maharashtra!5e0!3m2!1sen!2sin!4v1693300000000!5m2!1sen!2sin" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
    </div>
  </div>

  <section id="booking-section" class="hidden"></section>
  <section id="receipt-section" class="hidden"></section>
  <div id="parking-map-modal" class="modal"></div>
    <!-- ... existing #parking-map-modal ... -->

  <!-- ... existing #parking-map-modal ... -->

  <div id="instructions-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="instructions-modal-close">√ó</span>
      <h2 class="card-title"><i class="fas fa-bullhorn"></i> Instructions</h2>
      


      <div id="instructions-text">
        <p><h1>Welcome to SmartPark!</h1></p>
        <p><h2>1. First, connect your wallet to manage your SPARK tokens.</h2></p>
        <p><h2>2.Select a parking zone from the list to see its location on the map.</h2></p>
        <p><h2>3. Click 'View Available Spots' to see a live map of the parking layout.</h2></p>
        <p><h2>4. Select your desired vacant spots and confirm your selection.</h2></p>
        <p><h2>5. Complete the booking form with your details.</h2></p>
        <p><strong>Please note:</strong><h1>Some parking areas are now equipped with dedicated EV charging stations.</h1></p>
      </div>
    </div>
  </div>
    <footer>
    <div class="footer-logo-line">
        <img src="13.png" alt="SmartPark Logo" class="footer-img"><div class="footer-links">
        <a href="#hero">HOME</a>
    </div> üöó SmartPark
    </div>
    <p class="footer-copy">¬© 2025 SmartPark. Built with ‚ù§Ô∏è by Aadesh Bhamare.</p>

   <div class="footer-logo-line">
        <!-- This is your new logo image -->
        <img src="logo.PNG" alt="SmartPark Company Logo" style="height:50px;horizontal-align:center;">
        <div class="logo">SmartPark</div>
    </div>
      </footer>
<!-- Add this new modal container to your HTML body -->
<div id="checkout-payment-modal" class="modal"></div>
  <script>
    // --- DOM Elements ---
    const mapContainer = document.getElementById('map-container'); const fullscreenBtn = document.getElementById('fullscreen-btn'); const mapIframe = document.getElementById('map-iframe'); const zonesContainer = document.getElementById('zonesContainer'); const mapSearchInput = document.getElementById('map-search-input'); const mapSearchBtn = document.getElementById('map-search-btn'); const walletStatusDiv = document.getElementById('walletStatus'); const tokenBalanceSpan = document.getElementById('tokenBalance'); const parkingMapModal = document.getElementById('parking-map-modal'); const sessionPanel = document.getElementById('sessionPanel'); const bookingSection = document.getElementById('booking-section'); const receiptSection = document.getElementById('receipt-section');
    
    // --- State & Data ---
    let currentUserBookings = []; let allParkingSpots = {}; let spotsToBook = []; let userTokenBalance = 150;
    
    const parkingZonesData = [
        { id: 'T1', name: "Trinity Academy of Engg", totalSpots: 70, lat: 18.455, lon: 73.935, address: "S. No. 25 & 27, A/P. Pisoli, Saswad - Bopdev - Pune Rd, next to Yewalewadi, Kondhwa, Pune, Maharashtra"},
        { id: 'K2', name: "Kumar Pacific Mall",      totalSpots: 120, lat: 18.5015, lon: 773.8723, address: "Shankar Sheth Rd, Pune, Maharashtra" },
        { id: 'W3', name: "Wakad Area (Phoenix)",    totalSpots: 90, lat: 18.6006, lon: 73.7566, address: "Wakad, Pimpri-Chinchwad, Maharashtra" },
        { id: 'A4', name: "Amanora Mall",            totalSpots: 150, lat: 18.5204, lon: 73.9399, address: "Hadapsar, Pune, Maharashtra" },
        { id: 'C5', name: "CIDCO",                   totalSpots: 80, lat: 19.8739, lon: 75.3669, address: "CIDCO, Nashik, Maharashtra" },
        { id: 'M6', name: "Market Yard",             totalSpots: 100, lat: 18.4877, lon: 73.8684, address: "Market Yard, Pune, Maharashtra" },
        { id: 'B7', name: "Wakdewadi Bus Stand",     totalSpots: 60, lat: 18.5431, lon: 73.8518, address: "Wakdewadi, Shivajinagar, Pune" }
    ];
    // --- Haversine Distance Function ---
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // metres
    const œÜ1 = lat1 * Math.PI / 180;
    const œÜ2 = lat2 * Math.PI / 180;
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
    const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    const d = R * c; // in metres
    return d / 1000; // in kilometers
}

// --- Display Zones with Distance ---
function displayParkingZonesWithDistances() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            const updatedZones = parkingZonesData.map(zone => {
                const distance = calculateDistance(userLat, userLon, zone.lat, zone.lon);
                return { ...zone, distance: distance.toFixed(2) + " km" };
            });

            // Sort by nearest
            const sortedZones = updatedZones.sort((a, b) => 
                parseFloat(a.distance) - parseFloat(b.distance)
            );

            // Render UI
            const list = document.getElementById("parkingZones");
            list.innerHTML = sortedZones.map(zone => `
                <li>
                  <strong>${zone.name}</strong> <br>
                  üìç ${zone.address} <br>
                  üÖøÔ∏è Spots: ${zone.totalSpots} <br>
                  üìè Distance: ${zone.distance}
                </li>
            `).join("");
        }, (error) => {
            console.error("Error getting user location:", error);
        });
    } else {
        console.log("Geolocation not supported.");
    }
}

// Call on load
displayParkingZonesWithDistances();
    // --- FUNCTIONS ---
    function initializeAllSpots() { parkingZonesData.forEach(zone => { allParkingSpots[zone.id] = Array.from({ length: zone.totalSpots }, (_, i) => ({ id: `${zone.id}-${String(i + 1).padStart(2, '0')}`, status: 'vacant' })); }); }
    
    function renderZones() {
        zonesContainer.innerHTML = '';
        parkingZonesData.forEach(zone => {
            const availableCount = allParkingSpots[zone.id].filter(s => s.status === 'vacant').length;
            zonesContainer.innerHTML += `<div class="zone-card" data-zone-id="${zone.id}" data-lat="${zone.lat}" data-lon="${zone.lon}"><div class="zone-header"><div class="zone-name">${zone.name}</div></div><div class="zone-body"><p>${zone.address}</p><div class="zone-detail"><span>Availability:</span> <span>${availableCount}/${zone.totalSpots}</span></div><button class="btn view-spots-btn" data-zone-id="${zone.id}" data-zone-name="${zone.name}"><i class="fas fa-th-large"></i> View Available Spots</button></div></div>`;
        });
    }
    
    function renderParkingMap(zoneId) {
        parkingMapModal.innerHTML = `
            <div class="modal-content">
                <span class="modal-close">√ó</span>
                <h2 class="card-title"><i class="fas fa-th-large"></i> Select Spots in ${parkingZonesData.find(z => z.id === zoneId).name}</h2>
                <div id="parking-map-container"></div>
                <div class="modal-footer">
                    <span id="selection-counter">Spots Selected: 0</span>
                    <button id="confirm-spot-selection" class="btn" disabled>Confirm</button>
                </div>
            </div>`;
        
        const mapContainer = parkingMapModal.querySelector('#parking-map-container');
        allParkingSpots[zoneId].forEach(spot => {
            const spotDiv = document.createElement('div');
            const userBooking = currentUserBookings.find(b => b.spotId === spot.id);
            let currentStatus = spot.status;
            if (userBooking) {
                currentStatus = userBooking.status === 'active' ? 'booked-by-user' : spot.status;
            }
            
            spotDiv.className = `parking-spot ${currentStatus}`;
            spotDiv.textContent = spot.id;
            if (currentStatus === 'vacant') spotDiv.dataset.spotId = spot.id;
            mapContainer.appendChild(spotDiv);
        });
    }
   
    function updateSessionPanel() {
        if (currentUserBookings.length > 0) {
            let sessionItemsHTML = currentUserBookings.map(booking => {
                if (booking.status === 'booked') {
                    const gracePeriodEnd = booking.bookingConfirmationTime + booking.gracePeriodDuration;
                    return `<li class="session-item">
                        <div><strong>Spot:</strong> ${booking.spotId}</div>
                        <div><strong>Ends at:</strong> <span id="countdown-${booking.spotId}">${new Date(gracePeriodEnd).toLocaleTimeString()}</span></div>
                        <button class="btn check-in-btn" data-spot-id="${booking.spotId}"><i class="fas fa-sign-in-alt"></i> Check-In</button>
                    </li>`;
                } else if (booking.status === 'active') {
                    return `<li class="session-item">
                        <div><strong>Spot:</strong> ${booking.spotId}</div>
                        <div><strong>Vehicle:</strong> ${booking.vehicleNo}</div>
                        <div><strong>Entry:</strong> ${new Date(booking.entryTime).toLocaleTimeString()}</div>
                        <button class="btn btn-danger end-session-btn" data-spot-id="${booking.spotId}"><i class="fas fa-stop-circle"></i> End</button>
                    </li>`;
                }
            }).join('');
            sessionPanel.innerHTML = `<h2 class="card-title"><i class="fas fa-check-circle"></i> Active Sessions (${currentUserBookings.length})</h2><ul class="session-list">${sessionItemsHTML}</ul>`;
        } else {
            sessionPanel.innerHTML = `<h2 class="card-title"><i class="fas fa-info-circle"></i> No Active Session</h2><p>Select a zone to begin.</p>`;
        }
    }

    function handleBooking(paymentMethod, form, gracePeriodDurationMs) {
        const bookingDetails = {
            entryTime: form.datetime.value,
            fullname: form.fullname.value,
            mobile: form.mobile.value,
            primaryVehicle: form.vehicle.value,
            paymentMethod: paymentMethod,
            bookedSpots: spotsToBook.join(', ')
        };

        const confirmationTime = Date.now();
        const zoneId = spotsToBook[0].split('-')[0];
        const zoneData = parkingZonesData.find(z => z.id === zoneId);

            spotsToBook.forEach(spotId => {
        currentUserBookings.push({
            spotId: spotId,
            vehicleNo: bookingDetails.primaryVehicle,
            entryTime: bookingDetails.entryTime,
            bookingConfirmationTime: confirmationTime,
            status: 'booked',
            gracePeriodDuration: gracePeriodDurationMs,
            mobile: bookingDetails.mobile,
            paymentMethod: paymentMethod // <-- This line is crucial
        });
            const spotIndex = allParkingSpots[zoneId].findIndex(s => s.id === spotId);
            if (spotIndex > -1) {
                allParkingSpots[zoneId][spotIndex].status = 'booked';
            }
        });

        const allBookings = JSON.parse(localStorage.getItem('allSmartParkBookings')) || [];
        allBookings.push(bookingDetails);
        localStorage.setItem('allSmartParkBookings', JSON.stringify(allBookings));
        updateSessionPanel();
        generateMapReceipt(bookingDetails, zoneData);
        bookingSection.innerHTML = '';
        bookingSection.classList.add('hidden');
        renderZones();
        spotsToBook = [];
        saveStateToLocalStorage(); 
    }

    function generateMapReceipt(details, zoneData) {
        receiptSection.classList.remove('hidden');
        receiptSection.innerHTML = `
            <h3><i class="fas fa-check-circle"></i> Booking Confirmed!</h3>
            <div class="receipt-layout">
                <div id="receipt-map-container"><iframe id="receipt-map-iframe" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d387190.2798821423!2d${zoneData.lon}!3d${zoneData.lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM40uNTgwMDUgTcKwNy4zNjIzNA!5e0!3m2!1sen!2sin!4v1626343526345!5m2!1sen!2sin&q=${zoneData.lat},${zoneData.lon}(${encodeURIComponent(zoneData.name)})" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
                <div class="receipt-details">
                    <div class="detail-item"><strong>Your Spot(s):</strong><span>${details.bookedSpots}</span></div>
                    <div class="detail-item"><strong>Name:</strong><span>${details.fullname}</span></div>
                    <div class="detail-item"><strong>Vehicle No.:</strong><span>${details.primaryVehicle}</span></div>
                    <div class="detail-item"><strong>Entry Time:</strong><span>${new Date(details.entryTime).toLocaleString()}</span></div>
                    <div id="receipt-buttons">
                        <button id="download-receipt" class="btn">Download Text</button>
                        <button id="send-receipt" class="btn">Send to Mobile</button>
                    </div>
                </div>
            </div>`;
        receiptSection.scrollIntoView();
        
        document.getElementById('send-receipt').addEventListener('click', () => {
            const message = encodeURIComponent(
                `‚úÖ SmartPark Confirmed!\n\n` +
                `Spots: ${details.bookedSpots}\n` +
                `Vehicle: ${details.primaryVehicle}\n` +
                `Time: ${new Date(details.entryTime).toLocaleString()}\n\n` +
                `Directions: https://www.google.com/maps?q=${zoneData.lat},${zoneData.lon}`
            );
            const whatsappURL = `https://wa.me/91${details.mobile}?text=${message}`;
            window.open(whatsappURL, "_blank");
        });

        document.getElementById('download-receipt').addEventListener('click', () => {
            const receiptText = `SmartPark Booking Receipt\nSpots: ${details.bookedSpots}\nName: ${details.fullname}\nVehicle: ${details.primaryVehicle}\nTime: ${new Date(details.entryTime).toLocaleString()}`;
            const blob = new Blob([receiptText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'SmartPark_Receipt.txt';
            a.click();
            URL.revokeObjectURL(url);
        });
    }
    
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const toRad = (deg) => deg * (Math.PI / 180);

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c;
}


   // In the <script> section

function proceedToBooking(gracePeriodDurationMs) {
    parkingMapModal.classList.remove('show');
    bookingSection.classList.remove('hidden');
    // This HTML now includes the "UPI" option again.
    bookingSection.innerHTML = `<h2>Complete Your Booking</h2>
        <form id="booking-form">
            <label>Selected Spots</label>
            <div id="selected-spots-list">${spotsToBook.map(id => `<span class="spot-tag">${id}</span>`).join('')}</div>
            <label for="fullname">Full Name</label><input type="text" id="fullname" name="fullname" required />
            <label for="mobile">Mobile Number</label><input type="tel" id="mobile" name="mobile" pattern="[0-9]{10}" required />
            <label for="vehicle">Vehicle Number</label><input type="text" id="vehicle" name="vehicle" required />
            <label for="datetime">Entry Time</label><input type="datetime-local" id="datetime" name="datetime" required />
            <label for="payment">Payment Method</label>
            <select id="payment" name="payment" required>
                <option value="" disabled selected>Select...</option>
                <option value="card">Card</option>
                <option value="upi">UPI</option> 
                <option value="wallet">SPARK Wallet</option>
            </select>
            <button type="submit" class="btn" disabled>Pay & Confirm</button>
        </form>`;
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    bookingSection.querySelector('#datetime').value = now.toISOString().slice(0, 16);
    setupBookingFormListeners(gracePeriodDurationMs);
    bookingSection.scrollIntoView();
}
    function setupBookingFormListeners(gracePeriodDurationMs) {
        const form = document.getElementById('booking-form');
        if (!form) return;
        const paymentSelect = form.querySelector('#payment');
        const upiDiv = form.querySelector('#upi-payment');
        const submitBtn = form.querySelector('button[type="submit"]');

        form.addEventListener('input', () => { submitBtn.disabled = !form.checkValidity(); });
        paymentSelect.addEventListener('change', () => {
            upiDiv.style.display = paymentSelect.value === 'upi' ? 'block' : 'none';
            submitBtn.style.display = paymentSelect.value === 'upi' ? 'none' : 'block';
        });
        form.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleBooking(paymentSelect.value, form, gracePeriodDurationMs); 
        }
    );
    
        const confirmUpiBtn = form.querySelector('#confirm-payment-btn');
        if (confirmUpiBtn) {
            confirmUpiBtn.addEventListener('click', () => {
                if (!form.checkValidity()) { alert("Please fill in all details before confirming payment."); return; }
                handleBooking('UPI', form, gracePeriodDurationMs);
            });
        }
    }
    
    // --- EVENT LISTENERS ---
    function enterFullscreen() { if (mapContainer.requestFullscreen) { mapContainer.requestFullscreen(); } else if (mapContainer.webkitRequestFullscreen) { mapContainer.webkitRequestFullscreen(); } }
    fullscreenBtn.addEventListener('click', enterFullscreen);
    mapSearchBtn.addEventListener('click', () => { const query = mapSearchInput.value; if (query) { const encodedQuery = encodeURIComponent(query); mapIframe.src = `https://www.google.com/maps/embed/v1/place?key=YOUR_API_KEY&q=${encodedQuery}`; } });
    zonesContainer.addEventListener('click', (e) => {
        const card = e.target.closest('.zone-card');
        if (card) { document.getElementById('map-section').scrollIntoView(); const lat = card.dataset.lat; const lon = card.dataset.lon; const zoneName = card.querySelector('.zone-name').textContent; mapIframe.src = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15137.99972851218!2d${lon}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM40uNTgwMDUgTcKwNy4zNjIzNA!5e0!3m2!1sen!2sin!4v1626343526345!5m2!1sen!2sin&q=${lat},${lon}(${encodeURIComponent(zoneName)})`; }
        const spotsButton = e.target.closest('.view-spots-btn');
        if (spotsButton) { renderParkingMap(spotsButton.dataset.zoneId); parkingMapModal.classList.add('show'); }
    });
    
    parkingMapModal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-close')) { parkingMapModal.classList.remove('show'); }
        const spotDiv = e.target.closest('.parking-spot.vacant, .parking-spot.selected');
        if (spotDiv) { const spotId = spotDiv.dataset.spotId; const isSelected = spotsToBook.includes(spotId); if (isSelected) { spotsToBook = spotsToBook.filter(id => id !== spotId); spotDiv.classList.remove('selected'); } else { spotsToBook.push(spotId); spotDiv.classList.add('selected'); } parkingMapModal.querySelector('#selection-counter').textContent = `Spots Selected: ${spotsToBook.length}`; parkingMapModal.querySelector('#confirm-spot-selection').disabled = spotsToBook.length === 0; }
        
        const confirmBtn = e.target.closest('#confirm-spot-selection');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';

            const zoneId = spotsToBook[0].split('-')[0];
            const zoneData = parkingZonesData.find(z => z.id === zoneId);

            if (!navigator.geolocation) {
                alert("Geolocation is not supported. Using a default 15-minute grace period.");
                proceedToBooking(15 * 60 * 1000);
            } else {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        const distanceKm = getDistanceFromLatLonInKm(userLat, userLon, zoneData.lat, zoneData.lon);
                        
                        const AVERAGE_SPEED_KMPH = 25;
                        const travelTimeMinutes = (distanceKm / AVERAGE_SPEED_KMPH) * 60;
                        const BUFFER_MINUTES = 10;
                        const gracePeriodMinutes = Math.ceil(travelTimeMinutes) + BUFFER_MINUTES;

                        alert(`You are approx. ${distanceKm.toFixed(1)} km away.\nEstimated travel time: ${Math.ceil(travelTimeMinutes)} mins.\nYour booking will be held for ${gracePeriodMinutes} minutes.`);
                        
                        const gracePeriodDurationMs = gracePeriodMinutes * 60 * 1000;
                        proceedToBooking(gracePeriodDurationMs);
                    },
                    () => {
                        alert("Could not get your location. Using a default 15-minute grace period.");
                        proceedToBooking(15 * 60 * 1000);
                    }
                );
            }
        }
    });
sessionPanel.addEventListener('click', (e) => {
    const checkInBtn = e.target.closest('.check-in-btn');
        if (checkInBtn) {
            const spotIdToCheckIn = checkInBtn.dataset.spotId;
            const booking = currentUserBookings.find(b => b.spotId === spotIdToCheckIn);
            const zoneId = spotIdToCheckIn.split('-')[0];
            const spotIndex = allParkingSpots[zoneId].findIndex(s => s.id === spotIdToCheckIn);

            if (booking && spotIndex > -1) {
                booking.status = 'active';
                allParkingSpots[zoneId][spotIndex].status = 'occupied';
                alert(`Checked in successfully to spot ${spotIdToCheckIn}!`);
                updateSessionPanel();
                renderZones();
                saveStateToLocalStorage();
            }
        }

 const endSessionBtn = e.target.closest('.end-session-btn');
    if (endSessionBtn) {
        const spotIdToFree = endSessionBtn.dataset.spotId;
        const bookingToEnd = currentUserBookings.find(b => b.spotId === spotIdToFree);

        if (bookingToEnd) {
            const entryTime = new Date(bookingToEnd.entryTime).getTime();
            const exitTime = Date.now();
            const durationInHours = (exitTime - entryTime) / (1000 * 60 * 60);
            const parkedHours = Math.ceil(durationInHours);

            let parkingFee = 0;
               if (parkedHours <= 1) { parkingFee = 30; } 
            else if (parkedHours <= 2) { parkingFee = 50; } 
            else if (parkedHours <= 3) { parkingFee = 65; } 
            else if (parkedHours <= 4) { parkingFee = 80; } 
            else { parkingFee = 80 + (parkedHours - 4) * 15; }
            
             if (bookingToEnd.paymentMethod === 'wallet') {
                // Handle payment with SPARK Wallet
                if (userTokenBalance >= parkingFee) {
                    // Deduct from balance
                    userTokenBalance -= parkingFee;
                    localStorage.setItem('spark_balance', userTokenBalance); // Save new balance
                    updateWalletUI(); // Update display

                    alert(`Payment successful!\n${parkingFee.toFixed(2)} SPARK deducted from your wallet.\nNew Balance: ${userTokenBalance.toFixed(2)} SPARK`);
                    
                    // Finalize the session ending
                    const zoneId = spotIdToFree.split('-')[0];
                    const spotIndex = allParkingSpots[zoneId].findIndex(s => s.id === spotIdToFree);
                    if (spotIndex > -1) {
                        allParkingSpots[zoneId][spotIndex].status = 'vacant';
                    }
                    currentUserBookings = currentUserBookings.filter(b => b.spotId !== spotIdToFree);
                    updateSessionPanel();
                    renderZones();
                    saveStateToLocalStorage();
                } else {
                    alert(`Insufficient Funds!\nRequired: ${parkingFee.toFixed(2)} SPARK\nYour Balance: ${userTokenBalance.toFixed(2)} SPARK\n\nPlease use another payment method.`);
                }
            } else {
                // Handle other payment methods (like Card/UPI) by showing the QR modal
                showPaymentModal(spotIdToFree, parkedHours, parkingFee);
            }
        }
    }
});

    document.getElementById('logout-btn').addEventListener('click', e => { e.preventDefault(); sessionStorage.removeItem('userRole'); window.location.href = 'index.html'; });
    
    /**
 * Checks for expired bookings, sends a notice, clears the spot, and SAVES THE STATE.
 * UPDATED to fix the state-saving bug.
 */
function checkGracePeriodExpirations() {
    const now = Date.now();
    const bookingsToCancel = currentUserBookings.filter(booking =>
        booking.status === 'booked' && now > (booking.bookingConfirmationTime + booking.gracePeriodDuration)
    );

    if (bookingsToCancel.length > 0) {
        bookingsToCancel.forEach(booking => {
            // Your existing notification and spot-clearing logic
            const message = encodeURIComponent(
                `‚ùå SmartPark Cancellation\n\n` +
                `Your booking for spot ${booking.spotId} has been automatically cancelled because the grace period expired.\n\n` +
                `Please feel free to make a new booking.`
            );
            const whatsappURL = `https://wa.me/91${booking.mobile}?text=${message}`;
            window.open(whatsappURL, "_blank");

            const zoneId = booking.spotId.split('-')[0];
            const spotIndex = allParkingSpots[zoneId].findIndex(s => s.id === booking.spotId);
            if (spotIndex > -1) {
                allParkingSpots[zoneId][spotIndex].status = 'vacant';
            }
        });

        // Remove the cancelled bookings from the current session
        currentUserBookings = currentUserBookings.filter(booking => !bookingsToCancel.includes(booking));
        
        // Update the user interface
        updateSessionPanel();
        renderZones();

        // --- THE FIX ---
        // Save the updated (cancelled) state back to localStorage
        saveStateToLocalStorage(); 
        
        console.log(`${bookingsToCancel.length} booking(s) cancelled due to grace period expiration.`);
    }
}
    setInterval(checkGracePeriodExpirations, 60000);

    // --- Initial Load ---
document.addEventListener('DOMContentLoaded', () => { 
    // 1. LOAD THE SAVED STATE. This is the only change to the startup logic.
    loadStateFromLocalStorage();

    // 2. The rest of your code runs as before, but now with the loaded data.
    renderZones(); 
    initializeAllSpots();
    updateSessionPanel(); 
    tokenBalanceSpan.textContent = `${userTokenBalance} SPARK`;
    saveStateToLocalStorage 
    document.getElementById('connectWallet').addEventListener('click', connectWallet);
    document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
// --- Instructions Modal & Text-to-Speech Feature ---
  updateWalletUI(); 
const instructionFlag = document.getElementById('instruction-flag');
const instructionsModal = document.getElementById('instructions-modal');
const instructionsModalClose = document.getElementById('instructions-modal-close');
const instructionsText = document.getElementById('instructions-text').innerText;

instructionFlag.addEventListener('click', () => {
  instructionsModal.classList.add('show');
  
  // Using the Web Speech API to read the instructions
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(instructionsText);
    utterance.rate = 0.9; // Adjust speech rate as needed
    utterance.pitch = 1;    // Adjust pitch as needed
    window.speechSynthesis.speak(utterance);
  } else {
    console.log('Text-to-speech not supported in this browser.');
  }
});

function closeInstructions() {
  instructionsModal.classList.remove('show');
  // Stop the speech if the modal is closed
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
  }
}

instructionsModalClose.addEventListener('click', closeInstructions);

// Also close if user clicks outside the modal content
instructionsModal.addEventListener('click', (e) => {
    if (e.target === instructionsModal) {
        closeInstructions();
    }
});

    });
    // --- NEW FUNCTIONS FOR SAVING AND LOADING STATE ---

/**
 * Saves the current state of parking spots and the user's bookings to localStorage.
 */
// --- NEW FUNCTIONS FOR SAVING AND LOADING STATE (DOES NOT CHANGE OTHER LOGIC) ---

/**
 * Saves the current state to the browser's localStorage.
 */
function saveStateToLocalStorage() {
    try {
        // Save the global status of all parking spots for everyone to see
        localStorage.setItem('smartpark_all_spots_status', JSON.stringify(allParkingSpots));

        // Get the current logged-in user's name from session storage
        const customerName = sessionStorage.getItem('customerName');
        if (customerName) {
            // Create a unique key to save THIS user's bookings, keeping them private
            const userStorageKey = 'smartpark_bookings_' + customerName;
            localStorage.setItem(userStorageKey, JSON.stringify(currentUserBookings));
        }
    } catch (error) {
        console.error("Error saving state to localStorage:", error);
    }
}

/**
 * Loads the state from localStorage when the page first opens.
 */
function loadStateFromLocalStorage() {
    try {
        // Load the global status of all parking spots
        const savedAllSpots = localStorage.getItem('smartpark_all_spots_status');
        if (savedAllSpots) {
            allParkingSpots = JSON.parse(savedAllSpots);
        } else {
            // If no saved data exists, initialize the spots from scratch as before
            initializeAllSpots();
        } const savedBalance = localStorage.getItem('spark_balance');
        if (savedBalance) {
            userTokenBalance = parseFloat(savedBalance);
        }

        // Load the current user's specific bookings
        const customerName = sessionStorage.getItem('customerName');
        if (customerName) {
            const userStorageKey = 'smartpark_bookings_' + customerName;
            const savedUserBookings = localStorage.getItem(userStorageKey);
            if (savedUserBookings) {
                currentUserBookings = JSON.parse(savedUserBookings);
            }
        }
    } catch (error) {
        console.error("Error loading state from localStorage. Starting fresh.", error);
        // If there's an error (e.g., corrupted data), start with a clean slate
        initializeAllSpots();
        currentUserBookings = [];
    }
}
/**
 * Displays a modal for the user to complete payment at checkout.
 * @param {string} spotId - The ID of the parking spot.
 * @param {number} hours - The total hours parked.
 * @param {number} fee - The calculated parking fee.
 */
function showPaymentModal(spotId, hours, fee) {
    const checkoutModal = document.getElementById('checkout-payment-modal');
    // Dynamically generate the UPI URL for the QR code with the calculated fee
    const upiUrl = `upi://pay?pa=9421605173@axl&pn=SmartPark&am=${fee.toFixed(2)}`;
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiUrl)}`;

    checkoutModal.innerHTML = `
        <div class="modal-content">
            <span class="modal-close" id="checkout-modal-close">√ó</span>
            <h2 class="card-title"><i class="fas fa-money-check-alt"></i> Process Payment</h2>
            <div style="text-align: center; padding: 1rem;">
                <p style="margin-bottom: 0.5rem;"><strong>Spot:</strong> ${spotId}</p>
                <p style="margin-bottom: 1rem;"><strong>Parking Duration:</strong> ${hours} hour(s)</p>
                <h3 style="margin: 1rem 0; font-size: 1.5rem;">Total Fee: ${fee} rs</h3>
                <p>Scan the QR code with your UPI app to pay.</p>
                <a href="${upiUrl}">
                    <img src="${qrCodeUrl}" alt="UPI QR Code" style="margin: 1rem 0; border: 2px solid #ccc; border-radius: 8px; cursor: pointer;"/>
                </a>
                <button id="confirm-checkout-payment-btn" class="btn" style="margin-top: 1.5rem; width: 100%;">I Have Completed the Payment</button>
            </div>
        </div>
    `;
    checkoutModal.classList.add('show');

    // Event listener to close the modal
    document.getElementById('checkout-modal-close').addEventListener('click', () => {
        checkoutModal.classList.remove('show');
    });

    // Event listener for the confirmation button
    document.getElementById('confirm-checkout-payment-btn').addEventListener('click', () => {
        // This is the logic that was previously inside `if (paymentConfirmed)`
        alert(`Payment of ${fee} rs received! Session for spot ${spotId} ended.`);
        
        const zoneId = spotId.split('-')[0];
        const spotIndex = allParkingSpots[zoneId].findIndex(s => s.id === spotId);
        if (spotIndex > -1) {
            allParkingSpots[zoneId][spotIndex].status = 'vacant';
        }
        
        currentUserBookings = currentUserBookings.filter(b => b.spotId !== spotId);
        
        updateSessionPanel();
        renderZones();
        saveStateToLocalStorage();

        // Hide the modal after processing
        checkoutModal.classList.remove('show');
    });
}
// --- NEW WALLET MANAGEMENT FUNCTIONS ---

/**
 * Updates the wallet UI elements based on the current connection state and balance.
 */
// In the <script> section

/**
 * Updates the wallet UI elements based on the current connection state and balance.
 */
function updateWalletUI() {
    const connectBtn = document.getElementById('connectWallet');
    const disconnectBtn = document.getElementById('disconnectWallet');
    const isConnected = sessionStorage.getItem('walletConnected') === 'true';

    if (isConnected) {
        // Update status text and style
        walletStatusDiv.innerHTML = `<i class="fas fa-check-circle"></i> <span>Wallet Connected</span>`;
        walletStatusDiv.classList.add('connected');
        
        // Update balance display
        tokenBalanceSpan.textContent = `${userTokenBalance.toFixed(2)} SPARK`;
        
        // Toggle button visibility
        connectBtn.classList.add('hidden');
        disconnectBtn.classList.remove('hidden');
    } else {
        // Reset status text and style
        walletStatusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>Wallet not connected</span>`;
        walletStatusDiv.classList.remove('connected');
        
        // Reset balance display
        tokenBalanceSpan.textContent = `0 SPARK`;
        
        // Toggle button visibility
        connectBtn.classList.remove('hidden');
        disconnectBtn.classList.add('hidden');
    }
    
    // Dynamically update the payment options in the booking form
    updatePaymentOptions(isConnected);
}

/**
 * Enables or disables the 'SPARK Wallet' option in the booking form.
 * @param {boolean} isEnabled - Whether the wallet option should be enabled.
 */
function updatePaymentOptions(isEnabled) {
    // Check if the booking form is currently on the page
    const paymentSelect = document.querySelector('#payment');
    if (!paymentSelect) return;

    const walletOption = paymentSelect.querySelector('option[value="wallet"]');
    if (walletOption) {
        walletOption.disabled = !isEnabled;
        // If the wallet was selected and then the user disconnects, reset the selection.
        if (!isEnabled && paymentSelect.value === 'wallet') {
            paymentSelect.value = ""; // Set to the default empty value
        }
    }
}

/**
 * Simulates connecting to the wallet.
 */
function connectWallet() {
    // Use sessionStorage to remember connection status for the current tab session
    sessionStorage.setItem('walletConnected', 'true');
    
    // Load balance from localStorage (persistent) or set a default
    const savedBalance = localStorage.getItem('spark_balance');
    if (savedBalance) {
        userTokenBalance = parseFloat(savedBalance);
    } else {
        userTokenBalance = 150; // Default balance for a first-time user
        localStorage.setItem('spark_balance', userTokenBalance);
    }
    
    alert(`Wallet connected successfully!\nYour balance is: ${userTokenBalance.toFixed(2)} SPARK`);
    updateWalletUI(); // Update all UI elements
}

/**
 * Simulates disconnecting from the wallet.
 */
function disconnectWallet() {
    // Clear the session flag
    sessionStorage.setItem('walletConnected', 'false');
    alert('Wallet has been disconnected.');
    updateWalletUI(); // Update all UI elements
}
  </script>
</body>

</html>






